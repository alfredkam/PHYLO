<!doctype html>
<html lang='UTF8'>
<head>
	<title>PHYLO Translation Generator</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<link rel="shortcut icon" type="image/ico" href="img/phylo_icon.ico" />
	<script type="text/javascript" src="lib/jquery/jquery.js"></script>
	<script type="text/javascript" src="lib/underscore/underscore.js"></script>
	<script type="text/javascript" src="js/phylo-lib/helper.core.js"></script>
	<script type="text/javascript" src="js/phylo-lib/lang.module.js"></script>
	<style type="text/css">
		td {
			width: 45%;
			border-bottom: 1px solid #555;
		}
	</style>
</head>
<body>
	<form id="generate" action="javascript:void(0)">
	<table><tbody id="main-forum">
		<tr id="main-forum-info-lang"><td><p>Source language is
		    <select id="src-lang">
		    <!-- Values correspond to language file names. Maintain an up to date listing here. -->
		    <option value="EN">English</option>
		    <option value="FR">Français</option>
		    <option value="HE">עברית</option>
		    <option value="PT">Português</option>
		    <option value="RO">Român</option>
		    <option value="RU">Pусский</option>
		    <option value="SP">Español</option>
		    <option value="ZH-CN">中文简体</option>
		    <option value="ZH-HK">中文繁體</option>
		    </select>.</p></td>
		    <td>Target language is
		    <input type="text" size="20" id="main-forum-info-lang-tgt" />.
		    </td></tr>
		<tr><td><p>Language code <span id="src-lang-code"></span>.</p></td>
		    <td><p>Language code <input type="text" size="5" id="tgt-lang-code" />.</p></td></tr>
		<tr id="main-forum-info-author"><td>Author: .</td>
		    <td>Author: <input size="75%" type="text" id="main-forum-info-author-tgt" />.</td></tr>
	</tbody></table>
	<input type="submit" value="Generate Translation Code" />
	</form>
	<div id="generatedcode"></div>
	<script type="text/javascript">
	function update_source_language() {
		src_lang_code = $("#src-lang option:selected").attr("value");
		$("#src-lang-code").text(src_lang_code);
		$.getScript("lang/"+src_lang_code+".js").done(function(script, textStatus) {
			var language = eval(src_lang_code+"script").lang[0];
			$("#main-forum-info-author").children().filter(function(idx) {return 1 ? idx == 0 : 0})
			.text("Author: "+language.info.author+".");
			var queue = []; // FIFO
			$.each(language, function(field, val) {
				if (field === "info"); // Special case for language, author.
				else {
					if (_.isString(language[field])) {
						alert("Source language uses an unrecognized format; some fields may be missing.");
						//TODO - not used presently.
					} else { queue.push([language[field], "main-forum-"+field.replace(/\s/g, "-")]); }
				}
			});
			while (queue.length > 0) {
				var tuple = queue.shift();
				var obj = tuple[0];
				var prefix = tuple[1];
				$.each(obj, function(field, val) {
					var ident = prefix+"-"+field.toString().replace(/\s/g, "-");
					if (_.isString(obj[field])) {
						if ($("#"+ident)[0]) {
							$("#"+ident).children().filter(function(idx) {return 1 ? idx == 0 : 0})
							.text(obj[field]);
						} else {
							$("#main-forum").append("<tr id=\""+ident+"\"><td>"
									                +obj[field]+"</td><td><input size=\"85%\" type=\"text\" id=\""+ident+"-tgt\" /></td></tr>");
						}
					} else { queue.push([obj[field], ident]); }
				});
			}
		}).fail(function(jqxhr, settings, exception) { console.log("Unable to load language."); });
	};
	$(document).ready(function(event) {
		$.ajaxSetup({ cache: true });
		update_source_language();
		$("#src-lang").change(update_source_language);
		$("#generate").submit(function() {
			var out_code = ["(function(){function g() {};g.prototype.lang=[{"];
			var src_lang = eval(src_lang_code+"script").lang[0];
			var queue = []; // deque
			$.each(src_lang, function(field, val) {
				if (_.isString(src_lang[field])) {
					//TODO - not used presently.
				} else { queue.push([src_lang[field], "main-forum-"+field.replace(/\s/g, "-"), field]); }
			});
			while (queue.length > 0) {
				var tuple = queue.shift();
				if (tuple === true) {
					out_code.push("},");
					continue;
				}
				var obj = tuple[0];
				var prefix = tuple[1];
				var inner = false;
				out_code.push("\""+tuple[2]+"\" : {");
				$.each(obj, function(field, val) {
					var ident = prefix+"-"+field.toString().replace(/\s/g, "-");
					if (_.isString(obj[field])) {
						// This must be in the table.
						var trans = $("#"+ident).children().filter(function(idx) {return 1 ? idx == 1 : 0})
						            .children().attr("value");
						out_code.push("\""+field+"\": \""+trans+"\",");
					} else {
						if (!inner) queue.unshift(true);
						queue.unshift([obj[field], ident, field]);
						inner = true;
					}
				});
				if (!inner) out_code.push("},");
			}
			out_code.push("}];");
			out_code.push("var proto = g.prototype, attr = [[\"lang\",proto.lang]];");
			out_code.push("common.exportSingleton(\""+$("#tgt-lang-code").attr("value")+"script\",g,attr)");
			out_code.push("})();");
			$("#generatedcode").empty()
			$("#generatedcode").append("<p>Please submit a copy of the following to the PHYLO project with file name "
			                           +$("#tgt-lang-code").attr("value")+".js</p>");
			$("#generatedcode").append("<pre>"+out_code.join("\n")+"</pre>");
			window.location.hash = "#generatedcode";
			return false;
		});
	});
	</script>
</body>
</html>
